68K GAS   			page 1


   1               	
   2               	.file"fs_nkc.c"
   3               	.globlnkc_file_operations
   4               	.section.rodata
   5               	.align2
   8               	nkc_file_operations:
   9 0000 0000 0000 	.longnkcfs_open
  10 0004 0000 0000 	.longnkcfs_close
  11 0008 0000 0000 	.longnkcfs_read
  12 000c 0000 0000 	.longnkcfs_write
  13 0010 0000 0000 	.longnkcfs_seek
  14 0014 0000 0000 	.long0
  15 0018 0000 0000 	.longnkcfs_remove
  16 001c 0000 0000 	.longnkcfs_getpos
  17 0020 0000 0000 	.long0
  18 0024 0000 0000 	.long0
  19 0028 0000 0000 	.long0
  20 002c 0000 0000 	.long0
  21 0030 0000 0000 	.long0
  22 0034 0000 0000 	.longnkcfs_rename
  23               	.text
  24               	.align2
  25               	.globlread_sector
  27               	read_sector:
  28 0000 4E56 FFF8 	link.w %fp,#-8
  29 0004 202E 0008 	move.l 8(%fp),%d0
  30 0008 2040      	move.l %d0,%a0
  31 000a 1028 0010 	move.b 16(%a0),%d0
  32 000e 4A00      	tst.b %d0
  33 0010 6704      	jeq .L2
  34 0012 7001      	moveq #1,%d0
  35 0014 607C      	jra .L3
  36               	.L2:
  37 0016 202E 0008 	move.l 8(%fp),%d0
  38 001a 2040      	move.l %d0,%a0
  39 001c 2010      	move.l (%a0),%d0
  40 001e 2040      	move.l %d0,%a0
  41 0020 2D68 002C 	move.l 44(%a0),-4(%fp)
  41      FFFC 
  42 0026 202E 0008 	move.l 8(%fp),%d0
  43 002a 2040      	move.l %d0,%a0
  44 002c 2010      	move.l (%a0),%d0
  45 002e 2F00      	move.l %d0,-(%sp)
  46 0030 4EB9 0000 	jsr nkc_readrec
  46      0000 
  47 0036 588F      	addq.l #4,%sp
  48 0038 1D40 FFFB 	move.b %d0,-5(%fp)
  49 003c 4280      	clr.l %d0
  50 003e 102E FFFB 	move.b -5(%fp),%d0
  51 0042 7201      	moveq #1,%d1
  52 0044 B280      	cmp.l %d0,%d1
  53 0046 673C      	jeq .L6
  54 0048 4E71      	nop
  55 004a 202E 0008 	move.l 8(%fp),%d0
  56 004e 2040      	move.l %d0,%a0
  57 0050 2010      	move.l (%a0),%d0
  58 0052 2040      	move.l %d0,%a0
68K GAS   			page 2


  59 0054 216E FFFC 	move.l -4(%fp),44(%a0)
  59      002C 
  60 005a 202E 0008 	move.l 8(%fp),%d0
  61 005e 2040      	move.l %d0,%a0
  62 0060 2028 000C 	move.l 12(%a0),%d0
  63 0064 2200      	move.l %d0,%d1
  64 0066 5281      	addq.l #1,%d1
  65 0068 202E 0008 	move.l 8(%fp),%d0
  66 006c 2040      	move.l %d0,%a0
  67 006e 2141 000C 	move.l %d1,12(%a0)
  68 0072 202E 0008 	move.l 8(%fp),%d0
  69 0076 2040      	move.l %d0,%a0
  70 0078 42A8 0008 	clr.l 8(%a0)
  71 007c 4280      	clr.l %d0
  72 007e 102E FFFB 	move.b -5(%fp),%d0
  73 0082 600E      	jra .L3
  74               	.L6:
  75 0084 202E 0008 	move.l 8(%fp),%d0
  76 0088 2040      	move.l %d0,%a0
  77 008a 117C 0001 	move.b #1,16(%a0)
  77      0010 
  78 0090 7001      	moveq #1,%d0
  79               	.L3:
  80 0092 4E5E      	unlk %fp
  81 0094 4E75      	rts
  83               	.align2
  84               	.globlwrite_sector
  86               	write_sector:
  87 0096 4E56 FFF8 	link.w %fp,#-8
  88 009a 202E 0008 	move.l 8(%fp),%d0
  89 009e 2040      	move.l %d0,%a0
  90 00a0 2010      	move.l (%a0),%d0
  91 00a2 2040      	move.l %d0,%a0
  92 00a4 2D68 002C 	move.l 44(%a0),-4(%fp)
  92      FFFC 
  93 00aa 202E 0008 	move.l 8(%fp),%d0
  94 00ae 2040      	move.l %d0,%a0
  95 00b0 2010      	move.l (%a0),%d0
  96 00b2 2F00      	move.l %d0,-(%sp)
  97 00b4 4EB9 0000 	jsr nkc_writerec
  97      0000 
  98 00ba 588F      	addq.l #4,%sp
  99 00bc 1D40 FFFB 	move.b %d0,-5(%fp)
 100 00c0 4280      	clr.l %d0
 101 00c2 102E FFFB 	move.b -5(%fp),%d0
 102 00c6 7205      	moveq #5,%d1
 103 00c8 B280      	cmp.l %d0,%d1
 104 00ca 6750      	jeq .L13
 105 00cc 4E71      	nop
 106 00ce 202E 0008 	move.l 8(%fp),%d0
 107 00d2 2040      	move.l %d0,%a0
 108 00d4 2010      	move.l (%a0),%d0
 109 00d6 2040      	move.l %d0,%a0
 110 00d8 216E FFFC 	move.l -4(%fp),44(%a0)
 110      002C 
 111 00de 202E 0008 	move.l 8(%fp),%d0
 112 00e2 2040      	move.l %d0,%a0
68K GAS   			page 3


 113 00e4 2028 000C 	move.l 12(%a0),%d0
 114 00e8 2200      	move.l %d0,%d1
 115 00ea 5281      	addq.l #1,%d1
 116 00ec 202E 0008 	move.l 8(%fp),%d0
 117 00f0 2040      	move.l %d0,%a0
 118 00f2 2141 000C 	move.l %d1,12(%a0)
 119 00f6 202E 0008 	move.l 8(%fp),%d0
 120 00fa 2040      	move.l %d0,%a0
 121 00fc 42A8 0008 	clr.l 8(%a0)
 122 0100 4878 0400 	pea 1024.w
 123 0104 42A7      	clr.l -(%sp)
 124 0106 2F2E FFFC 	move.l -4(%fp),-(%sp)
 125 010a 4EB9 0000 	jsr memset
 125      0000 
 126 0110 4FEF 000C 	lea (12,%sp),%sp
 127 0114 4280      	clr.l %d0
 128 0116 102E FFFB 	move.b -5(%fp),%d0
 129 011a 6002      	jra .L16
 130               	.L13:
 131 011c 4280      	clr.l %d0
 132               	.L16:
 133 011e 4E5E      	unlk %fp
 134 0120 4E75      	rts
 136               	.section.rodata
 137               	.LC0:
 138 0038 2065 7272 	.string" error fillfcb: not a filename\n"
 138      6F72 2066 
 138      696C 6C66 
 138      6362 3A20 
 138      6E6F 7420 
 139               	.text
 140               	.align2
 142               	nkcfs_open:
 143 0122 4E56 FFF0 	link.w %fp,#-16
 144 0126 4878 0030 	pea 48.w
 145 012a 4EB9 0000 	jsr malloc
 145      0000 
 146 0130 588F      	addq.l #4,%sp
 147 0132 2008      	move.l %a0,%d0
 148 0134 2D40 FFFA 	move.l %d0,-6(%fp)
 149 0138 4878 0012 	pea 18.w
 150 013c 4EB9 0000 	jsr malloc
 150      0000 
 151 0142 588F      	addq.l #4,%sp
 152 0144 2008      	move.l %a0,%d0
 153 0146 2D40 FFF6 	move.l %d0,-10(%fp)
 154 014a 4878 0400 	pea 1024.w
 155 014e 4EB9 0000 	jsr malloc
 155      0000 
 156 0154 588F      	addq.l #4,%sp
 157 0156 2008      	move.l %a0,%d0
 158 0158 2D40 FFF2 	move.l %d0,-14(%fp)
 159 015c 202E 0008 	move.l 8(%fp),%d0
 160 0160 2040      	move.l %d0,%a0
 161 0162 2028 0014 	move.l 20(%a0),%d0
 162 0166 2F00      	move.l %d0,-(%sp)
 163 0168 2F2E FFFA 	move.l -6(%fp),-(%sp)
68K GAS   			page 4


 164 016c 4EB9 0000 	jsr nkc_fillfcb
 164      0000 
 165 0172 508F      	addq.l #8,%sp
 166 0174 1D40 FFFF 	move.b %d0,-1(%fp)
 167 0178 4A2E FFFF 	tst.b -1(%fp)
 168 017c 6738      	jeq .L18
 169 017e 4879 0000 	pea .LC0
 169      0000 
 170 0184 4EB9 0000 	jsr nkc_write
 170      0000 
 171 018a 588F      	addq.l #4,%sp
 172 018c 2F2E FFFA 	move.l -6(%fp),-(%sp)
 173 0190 4EB9 0000 	jsr free
 173      0000 
 174 0196 588F      	addq.l #4,%sp
 175 0198 2F2E FFF6 	move.l -10(%fp),-(%sp)
 176 019c 4EB9 0000 	jsr free
 176      0000 
 177 01a2 588F      	addq.l #4,%sp
 178 01a4 2F2E FFF2 	move.l -14(%fp),-(%sp)
 179 01a8 4EB9 0000 	jsr free
 179      0000 
 180 01ae 588F      	addq.l #4,%sp
 181 01b0 7002      	moveq #2,%d0
 182 01b2 6000 0136 	jra .L19
 183               	.L18:
 184 01b6 202E FFFA 	move.l -6(%fp),%d0
 185 01ba 2040      	move.l %d0,%a0
 186 01bc 216E FFF2 	move.l -14(%fp),44(%a0)
 186      002C 
 187 01c2 202E 0008 	move.l 8(%fp),%d0
 188 01c6 2040      	move.l %d0,%a0
 189 01c8 2010      	move.l (%a0),%d0
 190 01ca 0280 0000 	and.l #2048,%d0
 190      0800 
 191 01d0 4A80      	tst.l %d0
 192 01d2 6730      	jeq .L20
 193 01d4 2F2E FFFA 	move.l -6(%fp),-(%sp)
 194 01d8 4EB9 0000 	jsr nkc_erase
 194      0000 
 195 01de 588F      	addq.l #4,%sp
 196 01e0 1D40 FFFF 	move.b %d0,-1(%fp)
 197 01e4 2F2E FFFA 	move.l -6(%fp),-(%sp)
 198 01e8 4EB9 0000 	jsr nkc_create
 198      0000 
 199 01ee 588F      	addq.l #4,%sp
 200 01f0 1D40 FFFF 	move.b %d0,-1(%fp)
 201 01f4 0C2E FFFF 	cmp.b #-1,-1(%fp)
 201      FFFF 
 202 01fa 6618      	jne .L21
 203 01fc 1D7C 0007 	move.b #7,-1(%fp)
 203      FFFF 
 204 0202 6010      	jra .L21
 205               	.L20:
 206 0204 2F2E FFFA 	move.l -6(%fp),-(%sp)
 207 0208 4EB9 0000 	jsr nkc_open
 207      0000 
68K GAS   			page 5


 208 020e 588F      	addq.l #4,%sp
 209 0210 1D40 FFFF 	move.b %d0,-1(%fp)
 210               	.L21:
 211 0214 4E71      	nop
 212 0216 4A2E FFFF 	tst.b -1(%fp)
 213 021a 672A      	jeq .L30
 214 021c 2F2E FFF6 	move.l -10(%fp),-(%sp)
 215 0220 4EB9 0000 	jsr free
 215      0000 
 216 0226 588F      	addq.l #4,%sp
 217 0228 2F2E FFFA 	move.l -6(%fp),-(%sp)
 218 022c 4EB9 0000 	jsr free
 218      0000 
 219 0232 588F      	addq.l #4,%sp
 220 0234 2F2E FFF2 	move.l -14(%fp),-(%sp)
 221 0238 4EB9 0000 	jsr free
 221      0000 
 222 023e 588F      	addq.l #4,%sp
 223 0240 7002      	moveq #2,%d0
 224 0242 6000 00A6 	jra .L19
 225               	.L30:
 226 0246 202E FFFA 	move.l -6(%fp),%d0
 227 024a 2040      	move.l %d0,%a0
 228 024c 216E FFF2 	move.l -14(%fp),44(%a0)
 228      002C 
 229 0252 202E 0008 	move.l 8(%fp),%d0
 230 0256 2040      	move.l %d0,%a0
 231 0258 2010      	move.l (%a0),%d0
 232 025a 7201      	moveq #1,%d1
 233 025c C081      	and.l %d1,%d0
 234 025e 1000      	move.b %d0,%d0
 235 0260 4A00      	tst.b %d0
 236 0262 671E      	jeq .L31
 237 0264 202E 0008 	move.l 8(%fp),%d0
 238 0268 2040      	move.l %d0,%a0
 239 026a 2010      	move.l (%a0),%d0
 240 026c 7202      	moveq #2,%d1
 241 026e C081      	and.l %d1,%d0
 242 0270 4A80      	tst.l %d0
 243 0272 660E      	jne .L31
 244 0274 202E FFFA 	move.l -6(%fp),%d0
 245 0278 2040      	move.l %d0,%a0
 246 027a 117C FFE4 	move.b #-28,28(%a0)
 246      001C 
 247 0280 600C      	jra .L32
 248               	.L31:
 249 0282 202E FFFA 	move.l -6(%fp),%d0
 250 0286 2040      	move.l %d0,%a0
 251 0288 117C FFE5 	move.b #-27,28(%a0)
 251      001C 
 252               	.L32:
 253 028e 202E FFF6 	move.l -10(%fp),%d0
 254 0292 2040      	move.l %d0,%a0
 255 0294 42A8 0004 	clr.l 4(%a0)
 256 0298 202E FFF6 	move.l -10(%fp),%d0
 257 029c 2040      	move.l %d0,%a0
 258 029e 42A8 0008 	clr.l 8(%a0)
68K GAS   			page 6


 259 02a2 202E FFF6 	move.l -10(%fp),%d0
 260 02a6 2040      	move.l %d0,%a0
 261 02a8 42A8 000C 	clr.l 12(%a0)
 262 02ac 202E FFF6 	move.l -10(%fp),%d0
 263 02b0 2040      	move.l %d0,%a0
 264 02b2 20AE FFFA 	move.l -6(%fp),(%a0)
 265 02b6 202E FFF6 	move.l -10(%fp),%d0
 266 02ba 2040      	move.l %d0,%a0
 267 02bc 4228 0010 	clr.b 16(%a0)
 268 02c0 202E 0008 	move.l 8(%fp),%d0
 269 02c4 2040      	move.l %d0,%a0
 270 02c6 2010      	move.l (%a0),%d0
 271 02c8 0280 0000 	and.l #2048,%d0
 271      0800 
 272 02ce 4A80      	tst.l %d0
 273 02d0 660A      	jne .L33
 274 02d2 2F2E FFF6 	move.l -10(%fp),-(%sp)
 275 02d6 4EBA FD28 	jsr read_sector
 276 02da 588F      	addq.l #4,%sp
 277               	.L33:
 278 02dc 202E 0008 	move.l 8(%fp),%d0
 279 02e0 2040      	move.l %d0,%a0
 280 02e2 216E FFF6 	move.l -10(%fp),24(%a0)
 280      0018 
 281 02e8 4280      	clr.l %d0
 282               	.L19:
 283 02ea 4E5E      	unlk %fp
 284 02ec 4E75      	rts
 286               	.align2
 288               	nkcfs_close:
 289 02ee 4E56 FFFC 	link.w %fp,#-4
 290 02f2 202E 0008 	move.l 8(%fp),%d0
 291 02f6 2040      	move.l %d0,%a0
 292 02f8 2028 0018 	move.l 24(%a0),%d0
 293 02fc 2D40 FFFC 	move.l %d0,-4(%fp)
 294 0300 202E FFFC 	move.l -4(%fp),%d0
 295 0304 2040      	move.l %d0,%a0
 296 0306 2010      	move.l (%a0),%d0
 297 0308 2040      	move.l %d0,%a0
 298 030a 1028 001C 	move.b 28(%a0),%d0
 299 030e 0C00 FFE5 	cmp.b #-27,%d0
 300 0312 6618      	jne .L35
 301 0314 202E FFFC 	move.l -4(%fp),%d0
 302 0318 2040      	move.l %d0,%a0
 303 031a 2028 0008 	move.l 8(%a0),%d0
 304 031e 4A80      	tst.l %d0
 305 0320 6F0A      	jle .L35
 306 0322 2F2E FFFC 	move.l -4(%fp),-(%sp)
 307 0326 4EBA FD6E 	jsr write_sector
 308 032a 588F      	addq.l #4,%sp
 309               	.L35:
 310 032c 202E FFFC 	move.l -4(%fp),%d0
 311 0330 2040      	move.l %d0,%a0
 312 0332 2010      	move.l (%a0),%d0
 313 0334 2040      	move.l %d0,%a0
 314 0336 1028 001C 	move.b 28(%a0),%d0
 315 033a 0C00 FFE5 	cmp.b #-27,%d0
68K GAS   			page 7


 316 033e 6618      	jne .L36
 317 0340 202E FFFC 	move.l -4(%fp),%d0
 318 0344 2040      	move.l %d0,%a0
 319 0346 2028 0008 	move.l 8(%a0),%d0
 320 034a 4A80      	tst.l %d0
 321 034c 6F0A      	jle .L36
 322 034e 2F2E FFFC 	move.l -4(%fp),-(%sp)
 323 0352 4EBA FD42 	jsr write_sector
 324 0356 588F      	addq.l #4,%sp
 325               	.L36:
 326 0358 202E FFFC 	move.l -4(%fp),%d0
 327 035c 2040      	move.l %d0,%a0
 328 035e 2010      	move.l (%a0),%d0
 329 0360 2F00      	move.l %d0,-(%sp)
 330 0362 4EB9 0000 	jsr nkc_close
 330      0000 
 331 0368 588F      	addq.l #4,%sp
 332 036a 202E FFFC 	move.l -4(%fp),%d0
 333 036e 2040      	move.l %d0,%a0
 334 0370 2010      	move.l (%a0),%d0
 335 0372 2040      	move.l %d0,%a0
 336 0374 2028 002C 	move.l 44(%a0),%d0
 337 0378 2F00      	move.l %d0,-(%sp)
 338 037a 4EB9 0000 	jsr free
 338      0000 
 339 0380 588F      	addq.l #4,%sp
 340 0382 202E FFFC 	move.l -4(%fp),%d0
 341 0386 2040      	move.l %d0,%a0
 342 0388 2010      	move.l (%a0),%d0
 343 038a 2F00      	move.l %d0,-(%sp)
 344 038c 4EB9 0000 	jsr free
 344      0000 
 345 0392 588F      	addq.l #4,%sp
 346 0394 2F2E FFFC 	move.l -4(%fp),-(%sp)
 347 0398 4EB9 0000 	jsr free
 347      0000 
 348 039e 588F      	addq.l #4,%sp
 349 03a0 4280      	clr.l %d0
 350 03a2 4E5E      	unlk %fp
 351 03a4 4E75      	rts
 353               	.align2
 355               	nkcfs_read:
 356 03a6 4E56 FFEC 	link.w %fp,#-20
 357 03aa 2D6E 0010 	move.l 16(%fp),-4(%fp)
 357      FFFC 
 358 03b0 202E 0008 	move.l 8(%fp),%d0
 359 03b4 2040      	move.l %d0,%a0
 360 03b6 2028 0018 	move.l 24(%a0),%d0
 361 03ba 2D40 FFF4 	move.l %d0,-12(%fp)
 362 03be 202E FFF4 	move.l -12(%fp),%d0
 363 03c2 2040      	move.l %d0,%a0
 364 03c4 1028 0010 	move.b 16(%a0),%d0
 365 03c8 4A00      	tst.b %d0
 366 03ca 6706      	jeq .L38
 367 03cc 4280      	clr.l %d0
 368 03ce 6000 00FC 	jra .L39
 369               	.L38:
68K GAS   			page 8


 370 03d2 202E FFF4 	move.l -12(%fp),%d0
 371 03d6 2040      	move.l %d0,%a0
 372 03d8 2010      	move.l (%a0),%d0
 373 03da 2040      	move.l %d0,%a0
 374 03dc 2D68 002C 	move.l 44(%a0),-16(%fp)
 374      FFF0 
 375 03e2 42AE FFF8 	clr.l -8(%fp)
 376 03e6 6000 00D8 	jra .L40
 377               	.L43:
 378 03ea 202E 000C 	move.l 12(%fp),%d0
 379 03ee D0AE FFF8 	add.l -8(%fp),%d0
 380 03f2 222E FFF4 	move.l -12(%fp),%d1
 381 03f6 2041      	move.l %d1,%a0
 382 03f8 2228 0008 	move.l 8(%a0),%d1
 383 03fc D2AE FFF0 	add.l -16(%fp),%d1
 384 0400 2041      	move.l %d1,%a0
 385 0402 1210      	move.b (%a0),%d1
 386 0404 2040      	move.l %d0,%a0
 387 0406 1081      	move.b %d1,(%a0)
 388 0408 202E FFF4 	move.l -12(%fp),%d0
 389 040c 2040      	move.l %d0,%a0
 390 040e 2028 0008 	move.l 8(%a0),%d0
 391 0412 2200      	move.l %d0,%d1
 392 0414 5281      	addq.l #1,%d1
 393 0416 202E FFF4 	move.l -12(%fp),%d0
 394 041a 2040      	move.l %d0,%a0
 395 041c 2141 0008 	move.l %d1,8(%a0)
 396 0420 202E FFF4 	move.l -12(%fp),%d0
 397 0424 2040      	move.l %d0,%a0
 398 0426 2028 0004 	move.l 4(%a0),%d0
 399 042a 2200      	move.l %d0,%d1
 400 042c 5281      	addq.l #1,%d1
 401 042e 202E FFF4 	move.l -12(%fp),%d0
 402 0432 2040      	move.l %d0,%a0
 403 0434 2141 0004 	move.l %d1,4(%a0)
 404 0438 53AE FFFC 	subq.l #1,-4(%fp)
 405 043c 52AE FFF8 	addq.l #1,-8(%fp)
 406 0440 6002      	jra .L41
 407               	.L52:
 408 0442 4E71      	nop
 409               	.L41:
 410 0444 202E FFF4 	move.l -12(%fp),%d0
 411 0448 2040      	move.l %d0,%a0
 412 044a 2028 0008 	move.l 8(%a0),%d0
 413 044e 0C80 0000 	cmp.l #1023,%d0
 413      03FF 
 414 0454 6E06      	jgt .L42
 415 0456 4AAE FFFC 	tst.l -4(%fp)
 416 045a 668E      	jne .L43
 417               	.L42:
 418 045c 4AAE FFFC 	tst.l -4(%fp)
 419 0460 675E      	jeq .L40
 420 0462 202E FFF4 	move.l -12(%fp),%d0
 421 0466 2040      	move.l %d0,%a0
 422 0468 2228 000C 	move.l 12(%a0),%d1
 423 046c 202E FFF4 	move.l -12(%fp),%d0
 424 0470 2040      	move.l %d0,%a0
68K GAS   			page 9


 425 0472 2010      	move.l (%a0),%d0
 426 0474 2040      	move.l %d0,%a0
 427 0476 3028 001A 	move.w 26(%a0),%d0
 428 047a 3000      	move.w %d0,%d0
 429 047c 0280 0000 	and.l #65535,%d0
 429      FFFF 
 430 0482 B081      	cmp.l %d1,%d0
 431 0484 6604      	jne .L44
 432 0486 4280      	clr.l %d0
 433 0488 6042      	jra .L39
 434               	.L44:
 435 048a 2F2E FFF4 	move.l -12(%fp),-(%sp)
 436 048e 4EBA FB70 	jsr read_sector
 437 0492 588F      	addq.l #4,%sp
 438 0494 2D40 FFEC 	move.l %d0,-20(%fp)
 439 0498 202E FFEC 	move.l -20(%fp),%d0
 440 049c 7201      	moveq #1,%d1
 441 049e B280      	cmp.l %d0,%d1
 442 04a0 670E      	jeq .L47
 443 04a2 7201      	moveq #1,%d1
 444 04a4 B280      	cmp.l %d0,%d1
 445 04a6 6216      	jhi .L51
 446 04a8 7263      	moveq #99,%d1
 447 04aa B280      	cmp.l %d0,%d1
 448 04ac 6708      	jeq .L48
 449 04ae 600A      	jra .L50
 450               	.L47:
 451 04b0 202E FFF8 	move.l -8(%fp),%d0
 452 04b4 6016      	jra .L39
 453               	.L48:
 454 04b6 4280      	clr.l %d0
 455 04b8 6012      	jra .L39
 456               	.L50:
 457 04ba 4280      	clr.l %d0
 458 04bc 600E      	jra .L39
 459               	.L51:
 460 04be 4E71      	nop
 461               	.L40:
 462 04c0 4AAE FFFC 	tst.l -4(%fp)
 463 04c4 6600 FF7C 	jne .L52
 464 04c8 202E FFF8 	move.l -8(%fp),%d0
 465               	.L39:
 466 04cc 4E5E      	unlk %fp
 467 04ce 4E75      	rts
 469               	.align2
 471               	nkcfs_write:
 472 04d0 4E56 FFE4 	link.w %fp,#-28
 473 04d4 2D6E 0010 	move.l 16(%fp),-8(%fp)
 473      FFF8 
 474 04da 422E FFE4 	clr.b -28(%fp)
 475 04de 422E FFE5 	clr.b -27(%fp)
 476 04e2 202E 0008 	move.l 8(%fp),%d0
 477 04e6 2040      	move.l %d0,%a0
 478 04e8 2028 0018 	move.l 24(%a0),%d0
 479 04ec 2D40 FFF4 	move.l %d0,-12(%fp)
 480 04f0 202E FFF4 	move.l -12(%fp),%d0
 481 04f4 2040      	move.l %d0,%a0
68K GAS   			page 10


 482 04f6 2010      	move.l (%a0),%d0
 483 04f8 2040      	move.l %d0,%a0
 484 04fa 2D68 002C 	move.l 44(%a0),-16(%fp)
 484      FFF0 
 485 0500 42AE FFFC 	clr.l -4(%fp)
 486 0504 6000 00A6 	jra .L54
 487               	.L57:
 488 0508 202E FFF4 	move.l -12(%fp),%d0
 489 050c 2040      	move.l %d0,%a0
 490 050e 2028 0008 	move.l 8(%a0),%d0
 491 0512 D0AE FFF0 	add.l -16(%fp),%d0
 492 0516 222E 000C 	move.l 12(%fp),%d1
 493 051a D2AE FFFC 	add.l -4(%fp),%d1
 494 051e 2041      	move.l %d1,%a0
 495 0520 1210      	move.b (%a0),%d1
 496 0522 2040      	move.l %d0,%a0
 497 0524 1081      	move.b %d1,(%a0)
 498 0526 202E FFF4 	move.l -12(%fp),%d0
 499 052a 2040      	move.l %d0,%a0
 500 052c 2028 0008 	move.l 8(%a0),%d0
 501 0530 2200      	move.l %d0,%d1
 502 0532 5281      	addq.l #1,%d1
 503 0534 202E FFF4 	move.l -12(%fp),%d0
 504 0538 2040      	move.l %d0,%a0
 505 053a 2141 0008 	move.l %d1,8(%a0)
 506 053e 202E FFF4 	move.l -12(%fp),%d0
 507 0542 2040      	move.l %d0,%a0
 508 0544 2028 0004 	move.l 4(%a0),%d0
 509 0548 2200      	move.l %d0,%d1
 510 054a 5281      	addq.l #1,%d1
 511 054c 202E FFF4 	move.l -12(%fp),%d0
 512 0550 2040      	move.l %d0,%a0
 513 0552 2141 0004 	move.l %d1,4(%a0)
 514 0556 53AE FFF8 	subq.l #1,-8(%fp)
 515 055a 52AE FFFC 	addq.l #1,-4(%fp)
 516 055e 6002      	jra .L55
 517               	.L63:
 518 0560 4E71      	nop
 519               	.L55:
 520 0562 202E FFF4 	move.l -12(%fp),%d0
 521 0566 2040      	move.l %d0,%a0
 522 0568 2028 0008 	move.l 8(%a0),%d0
 523 056c 0C80 0000 	cmp.l #1023,%d0
 523      03FF 
 524 0572 6E06      	jgt .L56
 525 0574 4AAE FFF8 	tst.l -8(%fp)
 526 0578 6E8E      	jgt .L57
 527               	.L56:
 528 057a 4AAE FFF8 	tst.l -8(%fp)
 529 057e 672C      	jeq .L54
 530 0580 2F2E FFF4 	move.l -12(%fp),-(%sp)
 531 0584 4EBA FB10 	jsr write_sector
 532 0588 588F      	addq.l #4,%sp
 533 058a 1D40 FFEF 	move.b %d0,-17(%fp)
 534 058e 4280      	clr.l %d0
 535 0590 102E FFEF 	move.b -17(%fp),%d0
 536 0594 7205      	moveq #5,%d1
68K GAS   			page 11


 537 0596 B280      	cmp.l %d0,%d1
 538 0598 670A      	jeq .L59
 539 059a 0C80 0000 	cmp.l #255,%d0
 539      00FF 
 540 05a0 6706      	jeq .L60
 541 05a2 6008      	jra .L54
 542               	.L59:
 543 05a4 701C      	moveq #28,%d0
 544 05a6 600C      	jra .L61
 545               	.L60:
 546 05a8 7005      	moveq #5,%d0
 547 05aa 6008      	jra .L61
 548               	.L54:
 549 05ac 4AAE FFF8 	tst.l -8(%fp)
 550 05b0 66AE      	jne .L63
 551 05b2 4280      	clr.l %d0
 552               	.L61:
 553 05b4 4E5E      	unlk %fp
 554 05b6 4E75      	rts
 556               	.align2
 558               	nkcfs_seek:
 559 05b8 4E56 FFEC 	link.w %fp,#-20
 560 05bc 202E 0008 	move.l 8(%fp),%d0
 561 05c0 2040      	move.l %d0,%a0
 562 05c2 2028 0018 	move.l 24(%a0),%d0
 563 05c6 2D40 FFF8 	move.l %d0,-8(%fp)
 564 05ca 202E 0010 	move.l 16(%fp),%d0
 565 05ce 7201      	moveq #1,%d1
 566 05d0 B280      	cmp.l %d0,%d1
 567 05d2 6712      	jeq .L67
 568 05d4 7202      	moveq #2,%d1
 569 05d6 B280      	cmp.l %d0,%d1
 570 05d8 6722      	jeq .L68
 571 05da 4A80      	tst.l %d0
 572 05dc 6646      	jne .L84
 573               	.L66:
 574 05de 2D6E 000C 	move.l 12(%fp),-4(%fp)
 574      FFFC 
 575 05e4 6046      	jra .L69
 576               	.L67:
 577 05e6 202E FFF8 	move.l -8(%fp),%d0
 578 05ea 2040      	move.l %d0,%a0
 579 05ec 2028 0004 	move.l 4(%a0),%d0
 580 05f0 2200      	move.l %d0,%d1
 581 05f2 D2AE 000C 	add.l 12(%fp),%d1
 582 05f6 2D41 FFFC 	move.l %d1,-4(%fp)
 583 05fa 6030      	jra .L69
 584               	.L68:
 585 05fc 202E FFF8 	move.l -8(%fp),%d0
 586 0600 2040      	move.l %d0,%a0
 587 0602 2010      	move.l (%a0),%d0
 588 0604 2040      	move.l %d0,%a0
 589 0606 3028 001A 	move.w 26(%a0),%d0
 590 060a 3000      	move.w %d0,%d0
 591 060c 0280 0000 	and.l #65535,%d0
 591      FFFF 
 592 0612 720A      	moveq #10,%d1
68K GAS   			page 12


 593 0614 E3A8      	lsl.l %d1,%d0
 594 0616 D0AE 000C 	add.l 12(%fp),%d0
 595 061a 2200      	move.l %d0,%d1
 596 061c 5381      	subq.l #1,%d1
 597 061e 2D41 FFFC 	move.l %d1,-4(%fp)
 598 0622 6008      	jra .L69
 599               	.L84:
 600 0624 2D6E 000C 	move.l 12(%fp),-4(%fp)
 600      FFFC 
 601 062a 4E71      	nop
 602               	.L69:
 603 062c 4878 0400 	pea 1024.w
 604 0630 2F2E FFFC 	move.l -4(%fp),-(%sp)
 605 0634 4EB9 0000 	jsr div
 605      0000 
 606 063a 508F      	addq.l #8,%sp
 607 063c 2D40 FFEE 	move.l %d0,-18(%fp)
 608 0640 2D41 FFF2 	move.l %d1,-14(%fp)
 609 0644 202E FFEE 	move.l -18(%fp),%d0
 610 0648 4A80      	tst.l %d0
 611 064a 6C08      	jge .L70
 612 064c 42AE FFEE 	clr.l -18(%fp)
 613 0650 6000 011A 	jra .L83
 614               	.L70:
 615 0654 222E FFEE 	move.l -18(%fp),%d1
 616 0658 202E FFF8 	move.l -8(%fp),%d0
 617 065c 2040      	move.l %d0,%a0
 618 065e 2010      	move.l (%a0),%d0
 619 0660 2040      	move.l %d0,%a0
 620 0662 3028 001A 	move.w 26(%a0),%d0
 621 0666 3000      	move.w %d0,%d0
 622 0668 0280 0000 	and.l #65535,%d0
 622      FFFF 
 623 066e B081      	cmp.l %d1,%d0
 624 0670 6C2C      	jge .L72
 625 0672 202E FFF8 	move.l -8(%fp),%d0
 626 0676 2040      	move.l %d0,%a0
 627 0678 2010      	move.l (%a0),%d0
 628 067a 2040      	move.l %d0,%a0
 629 067c 3028 001A 	move.w 26(%a0),%d0
 630 0680 3000      	move.w %d0,%d0
 631 0682 0280 0000 	and.l #65535,%d0
 631      FFFF 
 632 0688 5380      	subq.l #1,%d0
 633 068a 2D40 FFEE 	move.l %d0,-18(%fp)
 634 068e 202E FFF8 	move.l -8(%fp),%d0
 635 0692 2040      	move.l %d0,%a0
 636 0694 117C 0001 	move.b #1,16(%a0)
 636      0010 
 637 069a 6000 00D0 	jra .L83
 638               	.L72:
 639 069e 222E FFEE 	move.l -18(%fp),%d1
 640 06a2 202E FFF8 	move.l -8(%fp),%d0
 641 06a6 2040      	move.l %d0,%a0
 642 06a8 2010      	move.l (%a0),%d0
 643 06aa 2040      	move.l %d0,%a0
 644 06ac 3028 001A 	move.w 26(%a0),%d0
68K GAS   			page 13


 645 06b0 3000      	move.w %d0,%d0
 646 06b2 0280 0000 	and.l #65535,%d0
 646      FFFF 
 647 06b8 B081      	cmp.l %d1,%d0
 648 06ba 677E      	jeq .L73
 649 06bc 222E FFEE 	move.l -18(%fp),%d1
 650 06c0 202E FFF8 	move.l -8(%fp),%d0
 651 06c4 2040      	move.l %d0,%a0
 652 06c6 2010      	move.l (%a0),%d0
 653 06c8 2F01      	move.l %d1,-(%sp)
 654 06ca 2F00      	move.l %d0,-(%sp)
 655 06cc 4EB9 0000 	jsr nkc_setrec
 655      0000 
 656 06d2 508F      	addq.l #8,%sp
 657 06d4 1D40 FFF7 	move.b %d0,-9(%fp)
 658 06d8 4280      	clr.l %d0
 659 06da 102E FFF7 	move.b -9(%fp),%d0
 660 06de 7201      	moveq #1,%d1
 661 06e0 B280      	cmp.l %d0,%d1
 662 06e2 6746      	jeq .L76
 663 06e4 0C80 0000 	cmp.l #255,%d0
 663      00FF 
 664 06ea 677E      	jeq .L85
 665 06ec 4A80      	tst.l %d0
 666 06ee 6648      	jne .L86
 667               	.L75:
 668 06f0 2F2E FFF8 	move.l -8(%fp),-(%sp)
 669 06f4 4EBA F90A 	jsr read_sector
 670 06f8 588F      	addq.l #4,%sp
 671 06fa 1D40 FFF7 	move.b %d0,-9(%fp)
 672 06fe 4280      	clr.l %d0
 673 0700 102E FFF7 	move.b -9(%fp),%d0
 674 0704 7201      	moveq #1,%d1
 675 0706 B280      	cmp.l %d0,%d1
 676 0708 670E      	jeq .L80
 677 070a 7263      	moveq #99,%d1
 678 070c B280      	cmp.l %d0,%d1
 679 070e 6716      	jeq .L81
 680 0710 4A80      	tst.l %d0
 681 0712 6702      	jeq .L79
 682 0714 6012      	jra .L82
 683               	.L79:
 684 0716 6010      	jra .L82
 685               	.L80:
 686 0718 202E FFF8 	move.l -8(%fp),%d0
 687 071c 2040      	move.l %d0,%a0
 688 071e 117C 0001 	move.b #1,16(%a0)
 688      0010 
 689 0724 6002      	jra .L82
 690               	.L81:
 691 0726 4E71      	nop
 692               	.L82:
 693 0728 6010      	jra .L73
 694               	.L76:
 695 072a 202E FFF8 	move.l -8(%fp),%d0
 696 072e 2040      	move.l %d0,%a0
 697 0730 117C 0001 	move.b #1,16(%a0)
68K GAS   			page 14


 697      0010 
 698 0736 6002      	jra .L73
 699               	.L86:
 700 0738 4E71      	nop
 701               	.L73:
 702 073a 202E FFF8 	move.l -8(%fp),%d0
 703 073e 2040      	move.l %d0,%a0
 704 0740 216E FFFC 	move.l -4(%fp),4(%a0)
 704      0004 
 705 0746 222E FFF2 	move.l -14(%fp),%d1
 706 074a 202E FFF8 	move.l -8(%fp),%d0
 707 074e 2040      	move.l %d0,%a0
 708 0750 2141 0008 	move.l %d1,8(%a0)
 709 0754 202E FFEE 	move.l -18(%fp),%d0
 710 0758 2200      	move.l %d0,%d1
 711 075a 5281      	addq.l #1,%d1
 712 075c 202E FFF8 	move.l -8(%fp),%d0
 713 0760 2040      	move.l %d0,%a0
 714 0762 2141 000C 	move.l %d1,12(%a0)
 715 0766 4E71      	nop
 716 0768 6002      	jra .L83
 717               	.L85:
 718 076a 4E71      	nop
 719               	.L83:
 720 076c 4E5E      	unlk %fp
 721 076e 4E75      	rts
 723               	.align2
 725               	nkcfs_remove:
 726 0770 4E56 0000 	link.w %fp,#0
 727 0774 202E 0008 	move.l 8(%fp),%d0
 728 0778 2040      	move.l %d0,%a0
 729 077a 2028 0014 	move.l 20(%a0),%d0
 730 077e 2F00      	move.l %d0,-(%sp)
 731 0780 4EB9 0000 	jsr _nkc_remove
 731      0000 
 732 0786 588F      	addq.l #4,%sp
 733 0788 4E5E      	unlk %fp
 734 078a 4E75      	rts
 736               	.align2
 738               	nkcfs_getpos:
 739 078c 4E56 FFFC 	link.w %fp,#-4
 740 0790 202E 0008 	move.l 8(%fp),%d0
 741 0794 2040      	move.l %d0,%a0
 742 0796 2028 0018 	move.l 24(%a0),%d0
 743 079a 2D40 FFFC 	move.l %d0,-4(%fp)
 744 079e 202E FFFC 	move.l -4(%fp),%d0
 745 07a2 2040      	move.l %d0,%a0
 746 07a4 2028 0004 	move.l 4(%a0),%d0
 747 07a8 4E5E      	unlk %fp
 748 07aa 4E75      	rts
 750               	.align2
 752               	nkcfs_rename:
 753 07ac 4E56 0000 	link.w %fp,#0
 754 07b0 2F2E 0010 	move.l 16(%fp),-(%sp)
 755 07b4 2F2E 000C 	move.l 12(%fp),-(%sp)
 756 07b8 4EB9 0000 	jsr _nkc_rename
 756      0000 
68K GAS   			page 15


 757 07be 508F      	addq.l #8,%sp
 758 07c0 4E5E      	unlk %fp
 759 07c2 4E75      	rts
 761               	.section.rodata
 762               	.LC1:
 763 0058 4A41 444F 	.string"JADOSFS"
 763      5346 5300 
 764               	.LC2:
 765 0060 4100      	.string"A"
 766               	.LC3:
 767 0062 5100      	.string"Q"
 768               	.text
 769               	.align2
 770               	.globlnkcfs_init_fs
 772               	nkcfs_init_fs:
 773 07c4 4E56 0000 	link.w %fp,#0
 774 07c8 4879 0000 	pea nkc_file_operations
 774      0000 
 775 07ce 4879 0000 	pea .LC1
 775      0000 
 776 07d4 4879 0000 	pea .LC2
 776      0000 
 777 07da 4EB9 0000 	jsr register_driver
 777      0000 
 778 07e0 4FEF 000C 	lea (12,%sp),%sp
 779 07e4 4879 0000 	pea nkc_file_operations
 779      0000 
 780 07ea 4879 0000 	pea .LC1
 780      0000 
 781 07f0 4879 0000 	pea .LC3
 781      0000 
 782 07f6 4EB9 0000 	jsr register_driver
 782      0000 
 783 07fc 4FEF 000C 	lea (12,%sp),%sp
 784 0800 4E5E      	unlk %fp
 785 0802 4E75      	rts
 787               	.ident"GCC: (GNU) 4.5.1"
 788               	.section.note.GNU-stack,"",@progbits
68K GAS   			page 16


DEFINED SYMBOLS
                            *ABS*:00000000 fs_nkc.c
    {standard input}:8      .rodata:00000000 nkc_file_operations
    {standard input}:142    .text:00000122 nkcfs_open
    {standard input}:288    .text:000002ee nkcfs_close
    {standard input}:355    .text:000003a6 nkcfs_read
    {standard input}:471    .text:000004d0 nkcfs_write
    {standard input}:558    .text:000005b8 nkcfs_seek
    {standard input}:725    .text:00000770 nkcfs_remove
    {standard input}:738    .text:0000078c nkcfs_getpos
    {standard input}:752    .text:000007ac nkcfs_rename
    {standard input}:27     .text:00000000 read_sector
    {standard input}:86     .text:00000096 write_sector
    {standard input}:772    .text:000007c4 nkcfs_init_fs

UNDEFINED SYMBOLS
nkc_readrec
nkc_writerec
memset
malloc
nkc_fillfcb
nkc_write
free
nkc_erase
nkc_create
nkc_open
nkc_close
div
nkc_setrec
_nkc_remove
_nkc_rename
register_driver
