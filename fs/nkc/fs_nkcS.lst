68K GAS   			page 1


   1               	#include "../../nkc/nkc.h"
   0               	
   0               	
   1               	#ifndef __EQU_H
   2               	#include "../../nkc/macros.h"
   1               	#ifndef __MACROS_H
   2               	#define __MACROS_H
   3               	
   4               	
   5               	/* DEBUG MACROS */
   6               	#ifdef CONFIG_DEBUG_GIDE_S
   7               	
   8               	.macro dbg msg
   9               	        writeln \msg
  10               	.endm   
  11               	
  12               	.macro dbgwait
  13               	        waitcr
  14               	.endm
  15               	
  16               	
  17               	#else
  18               	.macro dbg msg
  19               	.endm
  20               	
  21               	.macro dbgwait
  22               	.endm
  23               	#endif     
  24               	
  25               	/*
  26               	   Ermittelt die PC-realtive effekive Addresse von var und legt sie in a0 ab.
  27               	   Wird für 68000 gebraucht, da dieser nur 64KB Addressierung kennt:
  28               		lea var(pc),a0 ; funktioniert i.A. nur ab 68020
  29               		LEA32A0 var    ; erledigt das für den 68000
  30               	
  31               		Die Subroutine _LEA32A0 liegt in start00.S
  32               	*/
  33               	
  34               	#ifdef M68000
  35               	.macro LEA32A0 var
  36               		move.l #\var,-(%sp)
  37               		move.l #1f,-(%sp)
  38               		jsr _LEA32A0
  39               	1:	addq.l #8,%sp
  40               	.endm
  41               	
  42               	.macro LEA32 var,reg
  43               		move.l #\var,-(%sp)
  44               		move.l #1f,-(%sp)
  45               		jsr _LEA32A0
  46               	1:	addq.l #8,%sp
  47               		movea.l %a0,\reg
  48               	.endm
  49               	
  50               	/* pea kann auch nur mit 16Bit Displacements ! i.e. "pea d16(pc)" */
  51               	.macro _LEA var,reg
  52               		pea #\var
68K GAS   			page 2


  53               		move.l (%sp)+,\reg
  54               	.endm
  55               	#endif
  56               	
  57               	
  58               	/* Gibt Text an momentaner Cursor Position aus */
  59               	.macro writeln  text             
  60               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
  61               	#ifdef M68000
  62               		LEA32A0 \text
  63               	#else
  64               	        lea \text,%a0
  65               	#endif
  66               	1:
  67               	        move.b (%a0)+,%d0
  68               	        beq 2f
  69               	        moveq #_CO2,%d7
  70               	        trap #1
  71               	        bra 1b
  72               	2:
  73               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
  74               	.endm
  75               	
  76               	.macro prntdot             
  77               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
  78               	        move.b #'.',%d0
  79               	        moveq #_CO2,%d7
  80               	        trap #1
  81               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
  82               	.endm
  83               	
  84               	
  85               	.macro crlf                      
  86               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
  87               	        moveq #_CRLF,%d7
  88               	        trap #1
  89               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
  90               	.endm
  91               	
  92               	
  93               	/* jumps to x,y position */
  94               	
  95               	.macro gotoxy x y           
  96               	 	movem.l %a0-%a6/%d0-%d7,-(%a7)
  97               	 	move.b #\x,%d1           /* d1=X (0..79)*/
  98               	 	move.b #\y,%d2           /* d2=Y (0..23)*/
  99               	 	moveq #_SETCURXY,%d7
 100               	 	trap #1
 101               	 	movem.l (%a7)+,%a0-%a6/%d0-%d7
 102               	.endm
 103               	
 104               	
 105               	.macro getxy x y           
 106               	 	movem.l %a0-%a6/%d0-%d7,-(%a7)
 107               	 	moveq #_GETCURXY,%d7
 108               	 	trap #1
 109               	 	move.b %d1,#\x           /* d1=X (0..79)*/
68K GAS   			page 3


 110               	 	move.b %d2,#\y           /* d2=Y (0..23)*/
 111               	 	movem.l (%a7)+,%a0-%a6/%d0-%d7
 112               	.endm
 113               	
 114               	.macro writexy size x y text            /* gibt einen text an x/y position aus*/
 115               	                            	   	/* TextGrüsse,X,Y,TextAddr (Nullterminiert)*/
 116               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
 117               	        move.b #\size,%d0
 118               	        move.w #\x,%d1
 119               	        move.w #\y,%d2
 120               	        lea \text,%a0
 121               	        moveq #_WRITE,%d7
 122               	        trap #1
 123               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
 124               	.endm
 125               	
 126               	
 127               	
 128               	.macro clrscr                    /* loescht den Bildschirm */
 129               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
 130               	        moveq #_CLRSCREEN,%d7
 131               	        trap #1
 132               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
 133               	.endm
 134               	
 135               	
 136               	
 137               	
 138               	.macro prthex2  value                 	/* gibt 2stellige HEX Zahl aus*/
 139               	                                	/* IN: WERT*/
 140               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
 141               	        move.l \value,%d0
 142               	        lea buffer(%pc),%a0
 143               	        moveq #_PRINT2X,%d7
 144               	        trap #1
 145               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
 146               	.endm
 147               	
 148               	
 149               	.macro prthex8  value            /* gibt 8stellige Hex Zahl aus */
 150               	                                 /* In: WERT */
 151               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
 152               	        move.l \value,%d0
 153               	#ifdef M68000
 154               		LEA32A0 buffer
 155               	#else
 156               	        lea buffer(%pc),%a0
 157               	#endif
 158               	        moveq #_PRINT8X,%d7
 159               	        trap #1
 160               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
 161               	.endm
 162               	
 163               	.macro waitcr                    /* Wartet auf CR (Enter) */
 164               	        movem.l %a0-%a6/%d0-%d7,-(%a7)
 165               	1:
 166               	        moveq #_CI,%d7
68K GAS   			page 4


 167               	        trap #1
 168               	        cmp.b #0xd,%d0
 169               	        bne.s 1b
 170               	        movem.l (%a7)+,%a0-%a6/%d0-%d7
 171               	.endm
 172               	
 173               	
 174               	.macro CMOS_READ index
 175               		movem.l %a0-%a1,-(%a7)
 176               		clr.l %d0
 177               		move.b \index,RTC_DS12887_INDEX.w
 178               		move.b RTC_DS12887_DATA.w,%d0
 179               		movem.l (%a7)+,%a0-%a1
 180               	.endm
 181               	
 182               	.macro BCD_TO_BIN
 183               		movem.l %d1,-(%a7)
 184               		move.l %d0,%d1
 185               		andi #0x0f,%d0
 186               		lsr #4,%d1
 187               		mulu #10,%d1
 188               		add %d1,%d0
 189               		movem.l (%a7)+,%d1
 190               	.endm
 191               	
 192               	.macro BIN_TO_BCD		/*ist zwar 2 Befehle länger, aber schneller und für alle 68xxx*/
 193               		movem.l %d1,-(%a7)
 194               		and.l #0xff,%d0		/*nur Byte gültig*/
 195               		divu #10,%d0
 196               		move %d0,%d1
 197               		lsl #4, %d1
 198               		swap %d0
 199               		add %d0, %d1
 200               		exg %d0, %d1
 201               		movem.l (%a7)+,%d1
 202               	.endm
 203               	
   3               	
   4               		.text 
   5               		.global _nkc_remove, _nkc_rename, _nkc_get_drive, _nkc_set_drive
   6               		
   7               	/*****************************************************************************
   8               	 * int _nkc_remove(char *name)
   9               	  * delete file
  10               	 *****************************************************************************/                    
  11               	_nkc_remove:
  12 0000 48E7 0102 		movem.l %d7/%a6,-(%sp)	/* used by jados frame-pointer */
  13 0004 206F 000C 		movea.l 12(%sp),%a0  	/* *name */
  14 0008 7E0B      		moveq #__uppercas, %d7	/* Dateinamen immer in Großbuchstaben */
  15 000a 4E46      		trap #6
  16               	#ifdef M68000
  17               		lea buffer,%a1   	/* *fcb  <<-- !!*/
  18               	#else
  19 000c 43FB 0170 		lea buffer(%pc),%a1   	/* *fcb  <<-- !!*/
  19      0000 0000 
  20               	#endif
  21 0014 206F 000C 		movea.l 12(%sp),%a0  	/* *name */
68K GAS   			page 5


  22 0018 7E12      		moveq #__fillfcb,%d7
  23 001a 4E46      		trap #6
  24               	#ifdef M68000
  25               		lea buffer,%a1 	/* *fcb  <<-- !!*/
  26               	#else
  27 001c 43FB 0170 		lea buffer(%pc),%a1 	/* *fcb  <<-- !!*/
  27      0000 0000 
  28               	#endif
  29 0024 7E11      		moveq #__erase,%d7
  30 0026 4E46      		trap #6
  31 0028 4CDF 4080 		movem.l (%sp)+,%d7/%a6
  32 002c 4E75      		rts
  33               		
  34               		
  35               	/*****************************************************************************
  36               	 * int _nkc_rename(char *old , char *new)
  37               	 * Rename a file (DOS function 56h,Int21)
  38               	 * z.B. rename C:/Mydir/myfile.dat c:/newdir/otherfile.dat
  39               	 *****************************************************************************/                    
  40               	_nkc_rename:
  41 002e 48E7 0122 		movem.l %d7/%a2/%a6,-(%sp)	/* used by jados frame-pointer */
  42 0032 206F 0014 		movea.l 20(%sp),%a0  	/* *newname */
  43 0036 7E0B      		moveq #__uppercas, %d7	/* Dateinamen immer in Großbuchstaben */
  44 0038 4E46      		trap #6
  45               	#ifdef M68000
  46               		lea buffer,%a1   	/* *fcb  */
  47               	#else
  48 003a 43FB 0170 		lea buffer(%pc),%a1   	/* *fcb  */
  48      0000 0000 
  49               	#endif
  50 0042 206F 0014 		movea.l 20(%sp),%a0  	/* *newname <<--! */
  51 0046 7E12      		moveq #__fillfcb,%d7
  52 0048 4E46      		trap #6
  53 004a 2449      		movea.l %a1, %a2
  54 004c 206F 0010 		movea.l 16(%sp),%a0  	/* *oldname */
  55 0050 7E0B      		moveq #__uppercas, %d7	/* Dateinamen immer in Großbuchstaben */
  56 0052 4E46      		trap #6
  57               	#ifdef M68000
  58               		lea buffer,%a1     /* <<--- !! */
  59               	#else
  60 0054 43FB 0170 		lea buffer(%pc),%a1     /* <<--- !! */
  60      0000 0000 
  61               	#endif
  62 005c D3FC 0000 		adda.l #64, %a1   	/* *fcb  */
  62      0040 
  63 0062 206F 0010 		movea.l 16(%sp),%a0  	/* *oldname */
  64 0066 7E12      		moveq #__fillfcb,%d7
  65 0068 4E46      		trap #6
  66 006a 7E15      		moveq #__rename, %d7
  67 006c 4E46      		trap #6
  68 006e 4CDF 4480 		movem.l (%sp)+, %d7/%a2/%a6
  69 0072 4E75      		rts
  70               	
  71               	/*****************************************************************************
  72               	 * int _nkc_get_drive();
  73               	 *
  74               	 * Return vaules:
68K GAS   			page 6


  75               	 * 	0 		= ramdisk
  76               	 *	1..4 	= disk 1..4
  77               	 *  5..30 	= harddisk partition A..Z
  78               	 *****************************************************************************/ 
  79               	_nkc_get_drive:
  80 0074 48E7 0122 		movem.l %d7/%a2/%a6,-(%sp)	/* used by jados frame-pointer */
  81 0078 4280      		clr.l %d0
  82 007a 7E35      		moveq #__getdrive,%d7		/* call jados */
  83 007c 4E46      		trap #6
  84 007e 4CDF 4480 		movem.l (%sp)+, %d7/%a2/%a6
  85 0082 4E75      		rts
  86               	/*****************************************************************************
  87               	 * void _nkc_set_drive(int drive);
  88               	 *
  89               	 * input:
  90               	 * 	0 		= ramdisk
  91               	 *	1..4 	= disk 1..4
  92               	 *  5..30 	= harddisk partition A..Z
  93               	 *****************************************************************************/  	
  94               	_nkc_set_drive:
  95 0084 48E7 0122 		movem.l %d7/%a2/%a6,-(%sp)	/* used by jados frame-pointer */
  96 0088 202F 0010 		move.l 16(%sp),%d0  		/* drive */
  97 008c 7E36      		moveq #__setdrive,%d7		/* call jados */
  98 008e 4E46      		trap #6
  99 0090 4CDF 4480 		movem.l (%sp)+, %d7/%a2/%a6
 100 0094 4E75      		rts 
 101               		
 102               		
 103               	.data
 104               	
 105 0000 0000 0000 	buffer:	ds.b 255	
 105      0000 0000 
 105      0000 0000 
 105      0000 0000 
 105      0000 0000 
68K GAS   			page 7


DEFINED SYMBOLS
           fs_nkcS.S:11     .text:00000000 _nkc_remove
           fs_nkcS.S:40     .text:0000002e _nkc_rename
           fs_nkcS.S:79     .text:00000074 _nkc_get_drive
           fs_nkcS.S:94     .text:00000084 _nkc_set_drive
           fs_nkcS.S:105    .data:00000000 buffer

NO UNDEFINED SYMBOLS
